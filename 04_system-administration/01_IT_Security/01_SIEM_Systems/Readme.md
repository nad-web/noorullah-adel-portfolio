
---

# Building a Home SIEM System: A Comprehensive Guide

## Table of Contents

1.  [Introduction to SIEM](#1-introduction-to-siem)
    *   [What is a SIEM?](#what-is-a-siem)
    *   [Why Build a Home SIEM?](#why-build-a-home-siem)
    *   [Project Goal](#project-goal)
2.  [Choosing Your SIEM Tool](#2-choosing-your-siem-tool)
    *   [Wazuh](#wazuh)
    *   [Graylog](#graylog)
    *   [ELK Stack](#elk-stack)
    *   [Our Choice: Wazuh](#our-choice-wazuh)
3.  [Project Overview: Building a Home SIEM with Wazuh](#3-project-overview-building-a-home-siem-with-wazuh)
    *   [Key Components](#key-components)
    *   [Prerequisites](#prerequisites)
4.  [Step-by-Step Implementation Guide (Wazuh)](#4-step-by-step-implementation-guide-wazuh)
    *   [Step 1: Planning and Preparation](#step-1-planning-and-preparation)
        *   [Hardware/VM Specifications](#hardwarevm-specifications)
        *   [Network Configuration](#network-configuration)
        *   [Operating System Installation (Ubuntu Server)](#operating-system-installation-ubuntu-server)
    *   [Step 2: Installing Wazuh Manager and its Components](#step-2-installing-wazuh-manager-and-its-components)
        *   [Install OpenJDK](#install-openjdk)
        *   [Install Elasticsearch](#install-elasticsearch)
        *   [Install Kibana](#install-kibana)
        *   [Install Wazuh Manager](#install-wazuh-manager)
        *   [Install Wazuh Dashboard (Kibana Plugin)](#install-wazuh-dashboard-kibana-plugin)
        *   [Initial Configuration and Verification](#initial-configuration-and-verification)
    *   [Step 3: Deploying Wazuh Agents](#step-3-deploying-wazuh-agents)
        *   [Agent Registration](#agent-registration)
        *   [Installing Agents on Windows Machines](#installing-agents-on-windows-machines)
        *   [Installing Agents on Linux Machines](#installing-agents-on-linux-machines)
        *   [Verifying Agent Connection](#verifying-agent-connection)
    *   [Step 4: Log Collection and Management](#step-4-log-collection-and-management)
        *   [How Agents Collect Logs](#how-agents-collect-logs)
        *   [Wazuh's Default Log Collection](#wazuhs-default-log-collection)
        *   [Custom Log Collection](#custom-log-collection)
        *   [Understanding Data Flow](#understanding-data-flow)
    *   [Step 5: Threat Detection and Rule Management](#step-5-threat-detection-and-rule-management)
        *   [Wazuh's Ruleset](#wazuhs-ruleset)
        *   [How Rules Work (Decoders, Rules, Alerts)](#how-rules-work-decoders-rules-alerts)
        *   [Viewing Alerts in Wazuh Dashboard](#viewing-alerts-in-wazuh-dashboard)
        *   [Creating Custom Rules (Example)](#creating-custom-rules-example)
        *   [MITRE ATT&CK Integration](#mitre-attck-integration)
    *   [Step 6: Alerting and Notifications](#step-6-alerting-and-notifications)
        *   [Configuring Email Alerts](#configuring-email-alerts)
        *   [Configuring Custom Integrations (Slack/Teams)](#configuring-custom-integrations-slackteams)
    *   [Step 7: Monitoring and Maintenance](#step-7-monitoring-and-maintenance)
        *   [Dashboard Navigation](#dashboard-navigation)
        *   [Reviewing Alerts and Events](#reviewing-alerts-and-events)
        *   [Agent Management](#agent-management)
        *   [System Health Monitoring](#system-health-monitoring)
        *   [Updates and Upgrades](#updates-and-upgrades)
5.  [Conclusion](#5-conclusion)

---

## 1. Introduction to SIEM

### What is a SIEM?

SIEM stands for **Security Information and Event Management**. It's a solution that helps organizations collect, analyze, and present security-related data from various sources across their IT infrastructure. The primary goal of a SIEM system is to provide a centralized view of security events, enabling real-time analysis of security alerts generated by network hardware and applications.

Key functions of a SIEM include:
*   **Log Collection:** Aggregating logs from diverse sources (servers, workstations, network devices, applications).
*   **Data Normalization:** Converting disparate log formats into a common, searchable format.
*   **Correlation:** Identifying relationships between seemingly unrelated events to detect complex threats.
*   **Threat Detection:** Using rules, signatures, and behavioral analysis to identify suspicious activities.
*   **Alerting:** Notifying security personnel of detected threats.
*   **Reporting:** Generating compliance and security posture reports.
*   **Forensics:** Providing historical data for incident investigation.

### Why Build a Home SIEM?

Building a home SIEM system offers several benefits, especially for cybersecurity enthusiasts, IT professionals, or anyone looking to enhance their home network security:
*   **Enhanced Security:** Gain deeper visibility into your home network, identifying unauthorized access attempts, malware activity, or misconfigurations.
*   **Learning Opportunity:** Hands-on experience with industry-standard security tools and practices. Understand log management, threat detection, and incident response workflows.
*   **Proactive Defense:** Move beyond basic antivirus. Detect threats that might bypass traditional security measures.
*   **Skill Development:** Develop valuable skills in system administration, network security, and data analysis, which are highly sought after in the IT industry.
*   **Cost-Effective:** Utilize powerful open-source tools to build a robust system without significant financial investment.

### Project Goal

The primary goal of this project is to set up a functional Home SIEM system capable of:
*   **Monitoring Logs:** Collect security logs (e.g., Windows Event Logs, Linux Syslog, firewall logs) from various machines within your home network.
*   **Detecting Suspicious Activity:** Utilize predefined and custom rules to identify potential security incidents, such as brute-force attacks, unauthorized access, or unusual network behavior.
*   **Generating Alerts:** Configure the system to send notifications when critical security events are detected, allowing for timely response.

## 2. Choosing Your SIEM Tool

Several open-source tools can form the backbone of a home SIEM. Here's a brief overview of popular choices:

### Wazuh

Wazuh is an open-source, enterprise-ready security monitoring solution. It integrates host-based intrusion detection (HIDS), security information and event management (SIEM), and security orchestration, automation, and response (SOAR) capabilities.

**Pros:**
*   Comprehensive features: Log analysis, file integrity monitoring, vulnerability detection, configuration assessment, rootkit detection, and active response.
*   Built-in rules and decoders for common operating systems and applications.
*   Easy integration with Elastic Stack (Elasticsearch, Kibana) for data storage and visualization.
*   Active community and good documentation.

**Cons:**
*   Can be resource-intensive for larger deployments.
*   Initial setup requires understanding of multiple components.

### Graylog

Graylog is a powerful open-source log management platform that can be extended to function as a SIEM. It excels at centralized log collection, parsing, and analysis.

**Pros:**
*   Excellent log collection and parsing capabilities.
*   Powerful search and dashboard features.
*   Scalable architecture.
*   Good for general log management in addition to security.

**Cons:**
*   Requires more manual effort to build out SIEM-specific detection rules and threat intelligence integrations compared to Wazuh's out-of-the-box HIDS features.
*   Alerting can be less granular without custom configurations.

### ELK Stack (Elasticsearch, Logstash, Kibana)

The ELK Stack (now Elastic Stack) is a collection of three open-source products from Elastic:
*   **Elasticsearch:** A distributed, RESTful search and analytics engine.
*   **Logstash:** A server-side data processing pipeline that ingests data from multiple sources simultaneously, transforms it, and then sends it to a "stash" like Elasticsearch.
*   **Kibana:** A free and open user interface that lets you visualize your Elasticsearch data and navigate the Elastic Stack.

**Pros:**
*   Extremely flexible and powerful for any type of log analysis.
*   Highly scalable.
*   Vast ecosystem of plugins and integrations.

**Cons:**
*   Requires significant configuration and development to transform it into a full-fledged SIEM. You'll need to build your own rules, dashboards, and alerting mechanisms from scratch.
*   Can be resource-intensive and complex to manage.

### Our Choice: Wazuh

For a Home SIEM system, **Wazuh** is an excellent choice due to its integrated SIEM and HIDS capabilities, out-of-the-box rulesets, and relatively straightforward integration with the Elastic Stack for visualization. It provides a more complete SIEM experience with less custom development compared to a barebones ELK stack, while offering more security-specific features than Graylog alone.

This documentation will focus on building a Home SIEM using **Wazuh**.

## 3. Project Overview: Building a Home SIEM with Wazuh

Our Home SIEM system using Wazuh will consist of the following logical components:

### Key Components

1.  **Wazuh Manager:** The central component that analyzes data received from agents, processes it, applies rules, and generates alerts. It also manages agents and stores configuration.
2.  **Wazuh Agents:** Lightweight software installed on the endpoints (Windows, Linux machines) you want to monitor. Agents collect logs, monitor file integrity, detect vulnerabilities, and send data to the Wazuh Manager.
3.  **Elasticsearch:** A distributed search and analytics engine that stores the alerts and events generated by the Wazuh Manager.
4.  **Kibana:** A data visualization dashboard that provides a user interface to interact with Elasticsearch data.
5.  **Wazuh Dashboard:** A plugin for Kibana that provides pre-built dashboards, visualizations, and tools specifically designed for managing and analyzing Wazuh data.

### Prerequisites

Before you begin, ensure you have the following:

*   **Dedicated Machine/VM:** A dedicated machine or virtual machine to host the Wazuh Manager, Elasticsearch, and Kibana.
    *   **Operating System:** Ubuntu Server (LTS version recommended, e.g., 22.04 LTS) is a good choice for stability and ease of installation.
    *   **Hardware Specifications (Minimum for Home Use):**
        *   **CPU:** 2-4 Cores
        *   **RAM:** 8-16 GB (16GB recommended for better performance with Elasticsearch)
        *   **Storage:** 100-200 GB SSD (SSD is crucial for Elasticsearch performance)
*   **Network Connectivity:** All machines (Wazuh server and agents) must be able to communicate with each other over the network.
*   **Internet Access:** Required during installation to download packages.
*   **Sudo Privileges:** A user account with `sudo` privileges on the Ubuntu Server machine.
*   **Target Endpoints:** At least one Windows or Linux machine to install a Wazuh Agent on.

## 4. Step-by-Step Implementation Guide (Wazuh)

This section details the installation and configuration of your Wazuh-based Home SIEM.

### Step 1: Planning and Preparation

#### Hardware/VM Specifications

As mentioned in the prerequisites, allocate sufficient resources. For a home lab with 5-10 agents, 4 CPU cores, 16GB RAM, and 200GB SSD storage is a good starting point for the Wazuh server. If you're running this on a virtual machine, ensure your host machine has enough resources to spare.

#### Network Configuration

*   **Static IP Address:** Assign a static IP address to your Wazuh server. This makes it easier for agents to connect and for you to access the Kibana dashboard.
    *   **Example (Ubuntu Server):** Edit `netplan` configuration.
        ```yaml
        # /etc/netplan/00-installer-config.yaml (or similar)
        network:
          ethernets:
            enp0s3: # Replace with your actual interface name
              dhcp4: no
              addresses: [192.168.1.100/24] # Your desired static IP
              routes:
                - to: default
                  via: 192.168.1.1 # Your gateway IP
              nameservers:
                addresses: [8.8.8.8, 8.8.4.4] # DNS servers
          version: 2
        ```
        Apply changes:
        ```bash
        sudo netplan apply
        ```
*   **Firewall Rules:** Open necessary ports on your Wazuh server.
    *   **Wazuh Manager:**
        *   `1514/TCP`: Agent registration (authd)
        *   `1515/TCP`: Agent communication (remoted)
    *   **Elasticsearch:**
        *   `9200/TCP`: Elasticsearch API (for Kibana and internal communication)
    *   **Kibana:**
        *   `5601/TCP`: Kibana web interface
    *   **Example (UFW on Ubuntu):**
        ```bash
        sudo ufw allow 1514/tcp
        sudo ufw allow 1515/tcp
        sudo ufw allow 9200/tcp
        sudo ufw allow 5601/tcp
        sudo ufw enable
        sudo ufw status
        ```

#### Operating System Installation (Ubuntu Server)

Install Ubuntu Server (e.g., 22.04 LTS) on your dedicated machine or VM. During installation:
*   Choose a strong password for your user.
*   Select "Install OpenSSH server" for remote access.
*   Do not install any other unnecessary services.

After installation, update your system:
```bash
sudo apt update && sudo apt upgrade -y
```

### Step 2: Installing Wazuh Manager and its Components

We will install Elasticsearch, Kibana, and Wazuh Manager on the same server for simplicity in a home environment.

#### Install OpenJDK

Elasticsearch requires Java.
```bash
sudo apt install openjdk-17-jdk -y
```

#### Install Elasticsearch

1.  **Import the GPG key:**
    ```bash
    sudo curl -fsSL https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo gpg --dearmor -o /usr/share/keyrings/elastic.gpg
    ```
2.  **Add the Elastic repository:**
    ```bash
    echo "deb [signed-by=/usr/share/keyrings/elastic.gpg] https://artifacts.elastic.co/packages/8.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-8.x.list
    ```
    *(Note: Replace `8.x` with the specific major version you intend to install, e.g., `8.12`. Always check the official Wazuh documentation for compatible Elastic Stack versions.)*
3.  **Update package list and install Elasticsearch:**
    ```bash
    sudo apt update
    sudo apt install elasticsearch -y
    ```
4.  **Configure Elasticsearch:**
    Edit `sudo nano /etc/elasticsearch/elasticsearch.yml`.
    *   Uncomment and set `network.host` to your server's static IP or `0.0.0.0` to listen on all interfaces.
    *   Uncomment and set `http.port` to `9200`.
    *   For a single-node setup, you might need to uncomment `discovery.type: single-node`.
    ```yaml
    # /etc/elasticsearch/elasticsearch.yml
    network.host: 0.0.0.0 # Or your server's static IP, e.g., 192.168.1.100
    http.port: 9200
    discovery.type: single-node # For a single node setup
    ```
    **Important:** Elasticsearch 8.x enables security by default. For a home lab, you might want to disable it initially for simpler setup, or follow the official Elastic documentation for setting up users and certificates. For this guide, we'll assume a less secure, simplified setup suitable for a *controlled home environment* where you understand the risks.
    To disable security (not recommended for production):
    ```yaml
    # /etc/elasticsearch/elasticsearch.yml
    xpack.security.enabled: false
    ```
    If you keep security enabled, you'll need to generate passwords and certificates later.
5.  **Start and enable Elasticsearch:**
    ```bash
    sudo systemctl daemon-reload
    sudo systemctl enable elasticsearch
    sudo systemctl start elasticsearch
    ```
6.  **Verify Elasticsearch status:**
    ```bash
    sudo systemctl status elasticsearch
    curl -X GET "http://localhost:9200" # If security is disabled
    ```
    You should see a JSON response with cluster information.

#### Install Kibana

1.  **Install Kibana:**
    ```bash
    sudo apt install kibana -y
    ```
2.  **Configure Kibana:**
    Edit `sudo nano /etc/kibana/kibana.yml`.
    *   Uncomment and set `server.port` to `5601`.
    *   Uncomment and set `server.host` to your server's static IP or `0.0.0.0`.
    *   Uncomment and set `elasticsearch.hosts` to point to your Elasticsearch instance (e.g., `http://localhost:9200`).
    ```yaml
    # /etc/kibana/kibana.yml
    server.port: 5601
    server.host: "0.0.0.0" # Or your server's static IP
    elasticsearch.hosts: ["http://localhost:9200"]
    ```
3.  **Start and enable Kibana:**
    ```bash
    sudo systemctl daemon-reload
    sudo systemctl enable kibana
    sudo systemctl start kibana
    ```
4.  **Verify Kibana status:**
    ```bash
    sudo systemctl status kibana
    ```
    Wait a few minutes for Kibana to fully start. You should be able to access Kibana via your web browser at `http://YOUR_SERVER_IP:5601`.

#### Install Wazuh Manager

1.  **Import the Wazuh GPG key:**
    ```bash
    sudo curl -sO https://packages.wazuh.com/key/GPG-KEY-WAZUH
    sudo gpg --dearmor -o /usr/share/keyrings/wazuh.gpg GPG-KEY-WAZUH
    ```
2.  **Add the Wazuh repository:**
    ```bash
    echo "deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main" | sudo tee /etc/apt/sources.list.d/wazuh.list
    ```
    *(Note: Replace `4.x` with the specific major version you intend to install, e.g., `4.7`. Always check the official Wazuh documentation for the latest versions and compatibility.)*
3.  **Update package list and install Wazuh Manager:**
    ```bash
    sudo apt update
    sudo apt install wazuh-manager -y
    ```
4.  **Start and enable Wazuh Manager:**
    ```bash
    sudo systemctl daemon-reload
    sudo systemctl enable wazuh-manager
    sudo systemctl start wazuh-manager
    ```
5.  **Verify Wazuh Manager status:**
    ```bash
    sudo systemctl status wazuh-manager
    ```

#### Install Wazuh Dashboard (Kibana Plugin)

This step integrates Wazuh's UI into Kibana.

1.  **Install the Wazuh Dashboard plugin:**
    ```bash
    sudo /usr/share/kibana/bin/kibana-plugin install https://packages.wazuh.com/4.x/ui/wazuh-kibana-app-4.x.x_8.x.x.zip
    ```
    *(Note: Replace `4.x` and `8.x` with the specific Wazuh and Elastic Stack versions you installed. E.g., `wazuh-kibana-app-4.7.2_8.12.0.zip` for Wazuh 4.7.2 and Elastic 8.12.0. Check Wazuh's official documentation for the exact URL and filename.)*
2.  **Restart Kibana:**
    ```bash
    sudo systemctl restart kibana
    ```
    Wait a few minutes for Kibana to restart and load the plugin.

#### Initial Configuration and Verification

1.  **Access Wazuh Dashboard:** Open your web browser and navigate to `http://YOUR_SERVER_IP:5601`.
2.  You should now see the Wazuh Dashboard. It might take a moment to load the initial data.
3.  Explore the dashboard. You'll see sections for Agents, Security Events, Integrity Monitoring, Vulnerabilities, etc. Initially, these will be empty as no agents are connected yet.

### Step 3: Deploying Wazuh Agents

Wazuh Agents are installed on the machines you want to monitor. They collect security data and forward it to the Wazuh Manager.

#### Agent Registration

Before an agent can send data, it needs to be registered with the Wazuh Manager. This generates a unique key for the agent.

1.  **On the Wazuh Manager:**
    Access the Wazuh Dashboard. Navigate to **Wazuh > Agents > Deploy new agent**.
    Select your operating system (Windows, Linux, macOS, etc.) and follow the instructions.
    The dashboard will provide the specific commands for installation and registration.

    Alternatively, you can manually generate a key on the manager:
    ```bash
    sudo /var/ossec/bin/manage_agents
    ```
    *   Press `A` to add a new agent.
    *   Enter the agent name (e.g., `my-windows-pc`, `linux-server-01`).
    *   Enter the IP address of the agent machine (optional, but good for tracking).
    *   Confirm.
    *   The tool will output an **Agent ID** and an **Authentication Key**. Copy this key; you'll need it for the agent installation.

#### Installing Agents on Windows Machines

1.  **Download the Wazuh Agent installer:**
    On your Windows machine, open a web browser and go to `https://packages.wazuh.com/4.x/windows/wazuh-agent-4.x.x-win.zip` (replace `4.x` with your Wazuh Manager version, e.g., `4.7`). Download the `.msi` installer.
2.  **Run the installer as Administrator:**
    *   Double-click the `.msi` file.
    *   Follow the prompts.
    *   When prompted for the **Wazuh Manager IP address**, enter the static IP of your Wazuh Manager server.
    *   If you manually generated a key, select the option to import a key and paste the key you copied earlier. Otherwise, the agent will attempt to register automatically.
3.  **Complete the installation.**
4.  **Start the Wazuh Agent service:**
    The installer usually starts the service. You can verify or manually start it from `services.msc` (look for "Wazuh Agent").
    Alternatively, using PowerShell (as Administrator):
    ```powershell
    sc.exe query WazuhSvc # Check status
    net start WazuhSvc # Start if not running
    ```

#### Installing Agents on Linux Machines

This example uses Debian/Ubuntu-based systems.

1.  **Import the Wazuh GPG key:**
    ```bash
    sudo curl -sO https://packages.wazuh.com/key/GPG-KEY-WAZUH
    sudo gpg --dearmor -o /usr/share/keyrings/wazuh.gpg GPG-KEY-WAZUH
    ```
2.  **Add the Wazuh repository:**
    ```bash
    echo "deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main" | sudo tee /etc/apt/sources.list.d/wazuh.list
    ```
3.  **Update package list and install Wazuh Agent:**
    ```bash
    sudo apt update
    sudo apt install wazuh-agent -y
    ```
4.  **Configure the Agent:**
    Edit `sudo nano /var/ossec/etc/ossec.conf`.
    Find the `<client>` section and set the `<manager>` IP address to your Wazuh Manager's IP.
    ```xml
    <!-- /var/ossec/etc/ossec.conf -->
    <client>
      <server>
        <address>YOUR_WAZUH_MANAGER_IP</address>
        <port>1514</port>
        <protocol>tcp</protocol>
      </server>
      <!-- Other client settings -->
    </client>
    ```
    If you manually generated a key, you'll need to import it:
    ```bash
    sudo /var/ossec/bin/manage_agents -i YOUR_AUTHENTICATION_KEY
    ```
5.  **Restart the Wazuh Agent service:**
    ```bash
    sudo systemctl daemon-reload
    sudo systemctl enable wazuh-agent
    sudo systemctl restart wazuh-agent
    ```
6.  **Verify Agent status:**
    ```bash
    sudo systemctl status wazuh-agent
    ```

#### Verifying Agent Connection

Go back to your Wazuh Dashboard (`http://YOUR_SERVER_IP:5601`).
Navigate to **Wazuh > Agents**. You should see your newly installed agents listed with a "Active" status after a few minutes. If an agent is not connecting, check:
*   Firewall rules on both the manager and agent.
*   IP address configuration in `ossec.conf` (agent) or during Windows installation.
*   Network connectivity between agent and manager.
*   Wazuh agent logs (`/var/ossec/logs/ossec.log` on Linux, `C:\Program Files (x86)\ossec-agent\ossec.log` on Windows).

### Step 4: Log Collection and Management

Once agents are connected, they start collecting data. This is the core of log collection.

#### How Agents Collect Logs

Wazuh Agents are configured to monitor various data sources on the endpoint:
*   **Windows Event Logs:** Security, System, Application, PowerShell, Sysmon (if installed).
*   **Linux Syslog:** `/var/log/auth.log`, `/var/log/syslog`, `/var/log/kern.log`, etc.
*   **File Integrity Monitoring (FIM):** Monitors changes to critical system files and directories.
*   **Configuration Assessment (SCA):** Checks system configurations against security benchmarks.
*   **Vulnerability Detection (VULN_DETECTION):** Scans for installed software vulnerabilities.
*   **Rootkit Detection:** Identifies hidden processes or files.
*   **Custom Log Files:** Can be configured to monitor specific application logs (e.g., web server logs, database logs).

#### Wazuh's Default Log Collection

Out-of-the-box, Wazuh agents are configured to collect common security-relevant logs. These configurations are defined in the `ossec.conf` file on the agent and can be centrally managed from the Wazuh Manager.

Example of default log collection in `ossec.conf` (agent):
```xml
<!-- /var/ossec/etc/ossec.conf (excerpt) -->
<ossec_config>
  <localfile>
    <log_all>no</log_all>
    <location>Security</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <localfile>
    <log_all>no</log_all>
    <location>System</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <localfile>
    <log_all>no</log_all>
    <location>Application</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <localfile>
    <log_all>no</log_all>
    <location>/var/log/auth.log</location>
    <log_format>syslog</log_format>
  </localfile>

  <localfile>
    <log_all>no</log_all>
    <location>/var/log/syslog</location>
    <log_format>syslog</log_format>
  </localfile>
  <!-- ... more default configurations ... -->
</ossec_config>
```

#### Custom Log Collection

You can instruct agents to collect logs from specific applications or custom locations. This is done by adding `<localfile>` entries to the agent's `ossec.conf` or, preferably, by using **Agent Configuration Groups** on the Wazuh Manager.

**Example: Monitoring Apache Access Logs on a Linux Agent**

1.  **On Wazuh Dashboard:**
    *   Go to **Wazuh > Management > Groups**.
    *   Create a new group (e.g., `webservers`) or select an existing one.
    *   Click on the group, then go to the **Configuration** tab.
    *   Click "Edit configuration" and add the following:
        ```xml
        <ossec_config>
          <localfile>
            <log_format>apache</log_format>
            <location>/var/log/apache2/access.log</location>
          </localfile>
        </ossec_config>
        ```
    *   Save the configuration.
2.  **Assign Agent to Group:**
    *   Go to **Wazuh > Agents**.
    *   Select the Linux agent(s) running Apache.
    *   Click "Assign to group" and select `webservers`.
    *   The agent will automatically pick up the new configuration and start sending Apache logs.

#### Understanding Data Flow

1.  **Agent:** Collects raw log data from various sources on the endpoint.
2.  **Agent to Manager:** Encrypts and compresses the raw data, then sends it over TCP port 1515 to the Wazuh Manager.
3.  **Wazuh Manager:**
    *   **Decoders:** Parse the raw log data into structured fields (e.g., `source_ip`, `username`, `event_id`).
    *   **Rules:** Apply detection logic to the decoded events. If an event matches a rule, an alert is generated. Rules have severity levels (e.g., 0-15).
    *   **Alerts:** Generated events that are deemed security-relevant.
4.  **Manager to Elasticsearch:** Alerts are sent to Elasticsearch for storage and indexing.
5.  **Kibana/Wazuh Dashboard:** Queries Elasticsearch to retrieve and visualize the alerts and events, providing a user-friendly interface for security monitoring.

### Step 5: Threat Detection and Rule Management

Wazuh's strength lies in its extensive ruleset and ability to detect a wide range of threats.

#### Wazuh's Ruleset

Wazuh comes with a rich set of predefined rules covering:
*   **Operating System Events:** Login attempts (success/failure), user creation, privilege escalation.
*   **Application Logs:** Web server errors, database activity.
*   **Compliance:** Rules aligned with standards like PCI DSS, HIPAA, NIST 800-53, GDPR.
*   **Malware Detection:** Signatures for known malware.
*   **Network Attacks:** Brute-force, port scans.
*   **File Integrity Monitoring (FIM) Alerts:** Changes to critical system files.
*   **Vulnerability Detection:** Alerts on vulnerable software.

#### How Rules Work (Decoders, Rules, Alerts)

1.  **Raw Log:** `Aug 11 10:00:00 mylinux sshd[1234]: Failed password for invalid user test from 192.168.1.5 port 54321 ssh2`
2.  **Decoder:** Parses the raw log into structured fields.
    *   `program_name: sshd`
    *   `action: Failed password`
    *   `user: test`
    *   `src_ip: 192.168.1.5`
    *   `protocol: ssh2`
3.  **Rule:** Checks the decoded fields against predefined conditions.
    *   Rule `5712`: "SSHD authentication failed." (Level 5)
    *   Rule `5710`: "Multiple SSHD authentication failures." (Level 10, correlated rule)
4.  **Alert:** If a rule matches, an alert is generated with a specific severity level. Higher levels indicate more critical events.

You can view decoders and rules in the Wazuh Dashboard under **Wazuh > Management > Rules** and **Decoders**.

#### Viewing Alerts in Wazuh Dashboard

*   **Security Events:** This is your primary view for all generated alerts. Navigate to **Wazuh > Security Events**.
*   You can filter by agent, rule ID, level, or search for specific keywords.
*   Click on an alert to see its detailed information, including the raw log, decoded fields, and the rule that triggered it.

#### Creating Custom Rules (Example)

You might want to create custom rules for specific applications or behaviors unique to your environment.

**Example: Alert on more than 3 failed SSH login attempts from the same IP within 60 seconds.**

Wazuh already has rules for this (e.g., `5710`), but this example demonstrates the process.

1.  **Identify a base rule:** Find the rule that triggers for a single failed SSH login (e.g., `5712`).
2.  **Create a custom rule file:**
    On the Wazuh Manager, create a new file in `/var/ossec/etc/rules/local_rules.xml` (or a new `.xml` file in this directory).
    ```xml
    <!-- /var/ossec/etc/rules/local_rules.xml -->
    <group name="local,syslog,sshd,">
      <rule id="100001" level="10" frequency="4" timeframe="60">
        <if_matched_sid>5712</if_matched_sid>
        <same_source_ip />
        <description>Multiple SSH authentication failures from same IP.</description>
        <group>authentication_failure,pci_dss_10.2.4,pci_dss_10.6.1,gdpr_IV.35.7.d,gdpr_IV.32.2,nist_800_53_AU.14,nist_800_53_AC.7,</group>
      </rule>
    </group>
    ```
    *   `id`: Unique ID (start from 100000 for custom rules).
    *   `level`: Severity (10 is high).
    *   `frequency`: Number of times the base rule must match.
    *   `timeframe`: Time window in seconds.
    *   `if_matched_sid`: The ID of the base rule to match (e.g., `5712` for SSH failed login).
    *   `same_source_ip`: Correlate events from the same source IP.
3.  **Restart Wazuh Manager:**
    ```bash
    sudo systemctl restart wazuh-manager
    ```
    Now, if an agent reports 4 failed SSH logins from the same IP within 60 seconds, rule `100001` will trigger a high-severity alert.

#### MITRE ATT&CK Integration

Wazuh maps many of its rules to the MITRE ATT&CK framework, providing context about attacker tactics and techniques. In the Wazuh Dashboard, when viewing an alert, you'll often see associated ATT&CK IDs, helping you understand the nature of the detected threat.

### Step 6: Alerting and Notifications

Getting alerts out of the system is crucial for timely response.

#### Configuring Email Alerts

Wazuh can send email notifications for specific alert levels.

1.  **Configure `ossec.conf` on the Wazuh Manager:**
    Edit `sudo nano /var/ossec/etc/ossec.conf`.
    Add or modify the `<global>` and `<alerts>` sections.
    ```xml
    <!-- /var/ossec/etc/ossec.conf (excerpt) -->
    <ossec_config>
      <global>
        <email_notification>yes</email_notification>
        <email_to>your_email@example.com</email_to>
        <smtp_server>smtp.your-isp.com</smtp_server>
        <email_from>wazuh@your-domain.com</email_from>
      </global>

      <alerts>
        <email_alert_level>10</email_alert_level> <!-- Send emails for alerts with level 10 or higher -->
        <log_alert_level>3</log_alert_level>
      </alerts>
      <!-- ... other configurations ... -->
    </ossec_config>
    ```
    *   Replace `your_email@example.com` with your actual email address.
    *   Replace `smtp.your-isp.com` with your SMTP server. If your SMTP server requires authentication or SSL/TLS, you might need to configure `mail.config` in `/var/ossec/etc/ossec.conf` (refer to Wazuh documentation for advanced SMTP settings).
2.  **Restart Wazuh Manager:**
    ```bash
    sudo systemctl restart wazuh-manager
    ```
    Test by generating a high-level alert (e.g., multiple failed logins).

#### Configuring Custom Integrations (Slack/Teams)

Wazuh's `integrator` module allows sending alerts to external systems like Slack, Microsoft Teams, PagerDuty, etc., using webhooks.

**Example: Slack Integration**

1.  **Create a Slack Webhook:**
    In your Slack workspace, go to "Apps" and search for "Incoming WebHooks". Add it to a channel and copy the generated Webhook URL.
2.  **Configure `ossec.conf` on the Wazuh Manager:**
    Edit `sudo nano /var/ossec/etc/ossec.conf`.
    Add the `<integration>` block within the `<ossec_config>` section.
    ```xml
    <!-- /var/ossec/etc/ossec.conf (excerpt) -->
    <ossec_config>
      <integration>
        <name>slack</name>
        <hook_url>YOUR_SLACK_WEBHOOK_URL</hook_url>
        <level>12</level> <!-- Send alerts with level 12 or higher to Slack -->
        <alert_format>json</alert_format>
      </integration>
      <!-- ... other configurations ... -->
    </ossec_config>
    ```
    *   Replace `YOUR_SLACK_WEBHOOK_URL` with the URL you copied from Slack.
    *   Adjust `level` as desired.
3.  **Restart Wazuh Manager:**
    ```bash
    sudo systemctl restart wazuh-manager
    ```
    High-level alerts will now be sent to your specified Slack channel. Similar configurations apply for Microsoft Teams (using an Incoming Webhook connector).

### Step 7: Monitoring and Maintenance

A SIEM system is not a set-and-forget solution. Regular monitoring and maintenance are crucial.

#### Dashboard Navigation

Spend time familiarizing yourself with the Wazuh Dashboard:
*   **Overview:** High-level summary of agents, events, and alerts.
*   **Agents:** Manage agents, assign groups, view agent details.
*   **Security Events:** The main alert view, with powerful filtering and search.
*   **Integrity Monitoring:** View file integrity changes.
*   **Vulnerabilities:** See detected vulnerabilities on your endpoints.
*   **Compliance:** Check compliance posture against various standards.
*   **Modules:** Explore specific modules like Policy Monitoring, OpenSCAP, etc.
*   **Management:** Configure rules, decoders, groups, and API settings.

#### Reviewing Alerts and Events

*   **Daily Check:** Make it a habit to review high-severity alerts daily.
*   **Investigate:** When an alert triggers, investigate its context. What happened? Which machine? What user? Is it a false positive or a genuine threat?
*   **Tune Rules:** If you're getting too many false positives, consider tuning existing rules or creating new ones with more specific conditions.

#### Agent Management

*   **Monitor Agent Status:** Ensure all your agents are active and reporting.
*   **Update Agents:** Keep agents updated to the latest version for new features and security fixes. This can often be done centrally from the Wazuh Manager.
*   **Deploy New Agents:** As you add new devices to your network, deploy Wazuh agents on them.

#### System Health Monitoring

Monitor the health of your Wazuh Manager, Elasticsearch, and Kibana services:
*   **Disk Space:** Ensure Elasticsearch has enough disk space. Logs can grow quickly.
*   **CPU/RAM Usage:** Monitor resource consumption to ensure your server isn't overloaded.
*   **Service Status:** Regularly check if all services (`wazuh-manager`, `elasticsearch`, `kibana`) are running.
    ```bash
    sudo systemctl status wazuh-manager elasticsearch kibana
    ```
*   **Wazuh Logs:** Check Wazuh Manager logs for errors: `/var/ossec/logs/ossec.log`.

#### Updates and Upgrades

*   **Stay Current:** Regularly check the official Wazuh and Elastic documentation for new versions and security patches.
*   **Follow Upgrade Guides:** Always follow the official upgrade guides provided by Wazuh and Elastic when performing major version upgrades to avoid breaking your system.

## 5. Conclusion

You have now successfully built a foundational Home SIEM system using Wazuh. This system provides significant visibility into your home network's security posture, enabling you to detect and respond to threats more effectively.

**Next Steps and Further Learning:**

*   **Deep Dive into Wazuh Modules:** Explore advanced modules like Active Response (automated actions based on alerts), SCA (Security Configuration Assessment), and Vulnerability Detection.
*   **Advanced Rule Writing:** Learn more about Wazuh's rule syntax, pre-decoders, and advanced correlation techniques.
*   **Integrate More Logs:** Add logs from network devices (routers, firewalls via syslog), other applications, or even custom scripts.
*   **Threat Intelligence Integration:** Explore integrating external threat intelligence feeds into Wazuh to enrich alerts.
*   **Backup Strategy:** Implement a backup strategy for your Elasticsearch data and Wazuh configurations.
*   **Security Hardening:** Further secure your Wazuh server (e.g., using Nginx reverse proxy for Kibana with SSL, more robust firewall rules, disabling unnecessary services).
*   **Explore Alternatives:** While Wazuh is excellent, revisit Graylog or the bare ELK Stack if your needs evolve or you want to explore different approaches to log management and security analytics.

Building a SIEM is an ongoing process of learning, tuning, and adapting. Enjoy the journey of enhancing your cybersecurity skills and protecting your home network!
